---
title: "Project Checkpoint 3"
author: "Phuc Nguyen, Jina Park"
date: "November 8, 2017"

output: html_document
---

# Progress Made

- Created a Github repository for our R project.

- Cleaned the Chicago crime data by filtering out dates to only include crimes committed between 2010-2017, changed the categorical variables of Arrest and Domestic to binary variables, and changed the Date column from strings to datetime format.

- Obtained a Census API key and demographic data using acs and function called ‘get_tract_demographics.’

- Started looking up how to create maps using choropleth and choroplethrMaps packages


# Roles of each member

- Phuc wrote up the meanings of the variables in the Chicago crime data.

- Phuc typed up the commands to clean the data (i.e. change Date column to datetime format, change categorical variables to dummy variables, etc).

- Jina wrote up the meanings of the variables in the demographic data.

- Jina worked with choroplethr and acs to obtain the demographic data.

- Jina typed up this report.

- We both worked to set up a Github repository so that we could share the R files.

- We both worked together during the entire process and helped each other through most of the steps.


# Chicago Crime Data

### Description

This data set contains information about crime incidents from 2010 to present (2017) in Chicago.

We obtained this data from [https://data.cityofchicago.org/Public-Safety/Crimes-2001-to-present/ijzp-q8t2/data]

Some variables that we might use in our analysis are

- ID: unique identifier for each record

- Date: the best estimate of when (date, time) the incident occurred

- Primary Type: primary description of the incident according to the Illinoise Uniform Crime Reporting code [https://data.cityofchicago.org/d/c7ck-438e.]

- Description: subcategory of the primary description

- Location Description: description of the location where the incident occurred

- Arrest: Whether an arrest was made

- Domestic: Whether the incident was domestic-related according to Illinois Domestic Violence Act

- Beat: Indicates the beat where the incident occurred. A beat is the smallest police geographic area – each beat has a dedicated police beat car. Three to five beats make up a police sector, and three sectors make up a police district. The Chicago Police Department has 22 police districts. See the beats at [https://data.cityofchicago.org/d/aerh-rz74.]

- District: Indicates the police district where the incident occurred. See the districts at [https://data.cityofchicago.org/d/fthy-xz3r.]

- Ward: The ward (City Council district) where the incident occurred. See the wards at [https://data.cityofchicago.org/d/sp34-6z76.]

- Community Area: Indicates the community area where the incident occurred. Chicago has 77 community areas. See the community areas at [https://data.cityofchicago.org/d/cauq-8yn6.]

- Latitude: The latitude of the location where the incident occurred.

- Longitude: The longitude of the location where the incident occurred.

- Year: Year the incident occurred.


```{r , cache=TRUE}
Crime = read.csv('Crime_sample_2010_to_2017.csv')
```

```{r, cache=TRUE}
dim(Crime)
names(Crime)
head(Crime)
summary(Crime)
```


Code to clean data: convert 'true', 'false' values to 0 and 1, and date to date time format.

# Demographics Data

### Description

Source of Data: We used the get_tract_demographics function from the acs package (American Community Survey) to get demographic data on Census Tracts from the US Census Bureau. The data spans the years 2010-2017.

Variables that we will use:

- region: the region id (tract geoid) within a state

- total_population: the total population in the region

- percent_white: the percentage of people in the region that are white

- percent_black: the percentage of people in the region that are black

- percent_asian: the percentage of people in the region that are asian

- percent_hispanic: the percentage of people in the region that are hispanic

- per_capita_income: the capita per income of the region

- median_rent: the median rent of the region

- median_age: the median age of the region


```{r, cache=TRUE}
library(choroplethr)
library(choroplethrMaps)
library(acs)
api.key.install('23548fe7e771e8b0aeb4dd6e1ac95f7df1146a00')
illinois_demog <- read.csv("Illinois_demographic.csv")
illinois_demog
#write(illinois, 'Illinois_demographic.csv')
dim(illinois_demog)
names(illinois_demog)
head(illinois_demog)
summary(illinois_demog)
```

```{r}
library(plyr)
x <- data.frame(count(Crime,"Primary.Type"))
y <- data.frame(count(Crime, "Location.Description"))

colnames(x)[2] <- "type_count"
colnames(y)[2] <- "location_count"

y <- y %>%
  arrange(-location_count)

x <- x %>%
  arrange(-type_count) 

x <- x[1:15,]
y <- y[1:15,]

Crime1 <- left_join(Crime, x)
Crime2 <- left_join(Crime, y)

Crime1
Crime2
Crime <- Crime2 %>%
  filter(type_count > 50) %>%
  filter(!is.na(Latitude)) %>%
  filter(location_count > 100)
```

```{r}
library(ggplot2)
library(ggmap)
library(plotGoogleMaps)
library(dplyr)

locations <- with(Crime, as.data.frame(cbind(Longitude, Latitude)))

coordinates(locations) <- ~Longitude+Latitude

proj4string(locations) <- CRS("+init=epsg:4326")
CRS("+init=epsg:4326")


ChicagoMap <- qmap('chicago', zoom = 14,color = 'bw', legend = 'topleft')
plot(locations)
ChicagoMap
a <- plotGoogleMaps(locations, zoom = 19)
```


```{r}
library(maps)
library(ggplot2)
library(ggmap)
world_map <- map_data("state")
world_map
illinois <- subset(world_map, world_map$region=="illinois")
illinois

p <- ggplot() + coord_fixed() + 
  xlab("") + ylab("")
p
base_map <- p + geom_polygon(data=illinois, aes(x=long, y=lat, group=group), colour="blue", fill="blue")
base_map

cleanup <- 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        panel.background = element_rect(fill = 'white', colour = 'white'), 
        axis.line = element_line(colour = "white"), legend.position="none",
        axis.ticks=element_blank(), axis.text.x=element_blank(),
        axis.text.y=element_blank())

base_world <- base_map + cleanup
base_world

map_primary_type <- qmap('chicago', zoom = 14, color = 'bw') +
  geom_point(data=Crime, aes(x=Longitude, y=Latitude, colour=factor(Primary.Type), alpha=0.4, size = primary_count))
map_primary_type

map_location_desc <- qmap('chicago', zoom = 13,color = 'bw') +
  geom_point(data=Crime, aes(x=Longitude, y=Latitude, colour=factor(Location.Description)))
map_location_desc

map_arrest <- qmap('chicago', zoom = 14,color = 'bw', shape = 20) +
  geom_point(data=Crime, aes(x=Longitude, y=Latitude, colour = Arrest))
map_arrest

map_domestic <- qmap('chicago', zoom = 12,color = 'bw', shape = 20) +
  geom_point(data=Crime, aes(x=Longitude, y=Latitude, colour = Domestic))
map_domestic
```



```{r}
library(dplyr)
require(maptools)
require(tigris)
require(acs)
require(stringr)
require(leaflet)
```

```{r}
tracts <- tracts(state = 'IL', cb=TRUE)

fetched <- acs.fetch(
  geography = geo.make(state = "IL", county="*", tract="*"),
  endyear = 2012, span = 5,
  table.number = "B19001",
  col.names = "pretty"
)

names(attributes(fetched))
attr(fetched, "acs.colnames")

acs_df <- data.frame(
  paste0(
    str_pad(fetched@geography$state, 2, "left", pad="0"),
    str_pad(fetched@geography$county, 3, "left", pad="0"),
    str_pad(fetched@geography$tract, 6, "left", pad="0")),
  fetched@estimate[,c("Household Income: Total:", "Household Income: $200,000 or more")],
  stringsAsFactors = FALSE)

  
acs_df           <- select(acs_df, 1:3) %>% tbl_df()
rownames(acs_df) <- 1:nrow(acs_df)
names(acs_df)    <- c("GEOID", "total", "over_200")
acs_df$percent   <- 100*(acs_df$over_200/acs_df$total)
```

```{r}
df_merged <- geo_join(tracts, acs_df, "GEOID", "GEOID")

# there are some tracts with no land that we should exclude
df_merged <- df_merged[df_merged$ALAND>0,]
```

```{r}
popup <- paste0("GEOID: ", df_merged$GEOID, "<br>", "Percent of Households above $200k: ", round(df_merged$percent,2))
pal <- colorNumeric(
  palette = "YlGnBu",
  domain = df_merged$percent
)
```

```{r}
leaflet() %>%
  addProviderTiles("CartoDB.Positron") %>%
  addPolygons(data = df_merged, 
              fillColor = ~pal(percent), 
              color = "#b2aeae", # you need to use hex colors
              fillOpacity = 0.7, 
              weight = 1, 
              smoothFactor = 0.2,
              popup = popup) %>%
  addLegend(pal = pal, 
            values = df_merged$percent, 
            position = "bottomright", 
            title = "Percent of Households<br>above $200k",
            labFormat = labelFormat(suffix = "%")) 
```

