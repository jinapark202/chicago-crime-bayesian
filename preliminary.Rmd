---
title: "Project Checkpoint 4"
author: "Phuc Nguyen"
date: "November 14, 2017"
output: html_document
---

```{r}
#load data and library
library(tidyr)
library(dplyr)
library(choroplethr)
library(ggplot2)
require(maptools)
require(tigris)
require(acs)
require(stringr)
require(leaflet)
library(choroplethrMaps)
library(ggmap)

api.key.install('23548fe7e771e8b0aeb4dd6e1ac95f7df1146a00')
```

```{r}
Crime = read.csv('Crime_sample_2010_to_2017.csv')

Crime = Crime %>%
  mutate(Date = as.POSIXct(strptime(Date, "%Y-%m-%d %H:%M:%S")))

```


```{r}
library(plyr)

x <- data.frame(count(Crime, "Primary.Type"))
y <- data.frame(count(Crime, "Location.Description"))

colnames(x)[2] <- "type_count"
colnames(y)[2] <- "location_count"

y <- y %>%
  arrange(-location_count)

x <- x %>%
  arrange(-type_count) 

x <- x[1:15,]
y <- y[1:15,]

y
Crime1 <- left_join(Crime, x)
Crime2 <- left_join(Crime1, y)
Crime2

Crime <- Crime2 %>%
  filter(type_count > 50) %>%
  filter(!is.na(Latitude)) %>%
  filter(location_count > 100)
```

#Summary Statistics

Barplot for categorial variables of interests:

*Arrest

Around 25% of crimes results in arrests.

```{r}
sum(Crime$Arrest == 1)/nrow(Crime)
sum(Crime$Domestic == 1)/nrow(Crime)
```

```{r}
#arrest by crime type:
detach("package:plyr", unload=TRUE) 

temp = Crime %>% 
  select(Primary.Type, Arrest) %>%
  group_by(Primary.Type) %>%
  mutate(total_count = n()) %>%
  filter(Arrest==1) %>%
  mutate(arrest_count = n()) %>%
  mutate(arrest_rate = arrest_count/total_count) %>%
  distinct() %>%
  arrange(desc(arrest_count))

temp
```


#Visualization

*Arrest

```{r}
data = Crime %>% 
  filter(Arrest == 'true')
ggplot(data, aes(Primary.Type)) + geom_bar() +
  theme(axis.text.x = element_text( angle=90, hjust=1))

```

*Primary Type

```{r}
ggplot(Crime, aes(x=Primary.Type, fill=Arrest)) + geom_bar() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

*Domestic

```{r}
sum(Crime$Domestic == 'true')/nrow(Crime)
ggplot(Crime, aes(x=Primary.Type, fill=as.factor(Domestic))) + geom_bar() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

*Count of crime per District

```{r}
range(Crime$District)
ggplot(Crime, aes(District)) + geom_bar()
```

*Location Description

Only include locations whose counts are in the upper quantile.


```{r}
temp = Crime %>% 
  group_by(Location.Description) %>%
  summarise(count = n()) %>%
  filter(count >= quantile(count, 0.75))

data = Crime %>%
  left_join( temp, by='Location.Description') %>%
  filter(! is.na(count))

ggplot(data, aes(Location.Description)) + geom_bar() +
  theme(axis.text.x = element_text( angle = 90, hjust = 1))
```

Type of crime by location description

```{r, fig.width=15,fig.height=5}
ggplot(data, aes(Location.Description, fill=Primary.Type)) + geom_bar() +
  theme(axis.text.x = element_text( angle = 90, hjust = 1))
```

Arrest by location description

```{r}
ggplot(data, aes(Location.Description, fill=as.factor(Arrest))) + geom_bar() +
  theme(axis.text.x = element_text( angle = 90, hjust = 1))
```

Daily trend (time in a day) in number of crime by Primary Type

```{r, fig.width=15,fig.height=5}
daily_trend = Crime  %>% 
  mutate(hour = lubridate::hour(Date)) %>%
  group_by(hour, Primary.Type) %>%
  mutate( count = n())

ggplot(daily_trend, aes(hour, count, colour = Primary.Type)) + geom_line()
```

Seasonal trend (by month) in number of crime by Primary Type

```{r, fig.width=15,fig.height=5}
library(ggplot2)
yearly_trend = Crime  %>% 
  filter(Year == 2010) %>%
  mutate(month = lubridate::month(Date)) %>%
  group_by(month, Primary.Type) %>%
  mutate(count = n())

ggplot(yearly_trend, aes(month, count, colour=Primary.Type)) + geom_line()
```


## Map viz

Project latitude and longitude to tract polygon


```{r}
locations <- with(Crime, as.data.frame(cbind(Longitude, Latitude)))
locations <- locations[!is.na(locations$Longitude),]
coordinates(locations) <- ~Longitude+Latitude

proj4string(locations) <- CRS("+init=epsg:4326")
CRS("+init=epsg:4326")
```

```{r}
world_map <- map_data("state")
world_map
illinois <- subset(world_map, world_map$region=="illinois")

county_illinois <- map_data('county', 'illinois')
cook_county <- subset(county_illinois, county_illinois$subregion == "cook")
cook_county

map_primary_type <- qmap('chicago', zoom = 14, color = 'bw') +
  geom_point(data=Crime, aes(x=Longitude, y=Latitude, colour=factor(Primary.Type), alpha=0.4, size = type_count))
map_primary_type

map_location_desc <- qmap('chicago', zoom = 13,color = 'bw') +
  geom_point(data=Crime, aes(x=Longitude, y=Latitude, colour=factor(Location.Description)))
map_location_desc

map_arrest <- qmap('chicago', zoom = 14,color = 'bw', shape = 20) +
  geom_point(data=Crime, aes(x=Longitude, y=Latitude, colour = Arrest))
map_arrest

map_domestic <- qmap('chicago', zoom = 12,color = 'bw', shape = 20) +
  geom_point(data=Crime, aes(x=Longitude, y=Latitude, colour = Domestic))
map_domestic
```


```{r}
tracts <- tracts(state = 'IL', cb=TRUE)

fetched <- acs.fetch(
  geography = geo.make(state = "IL", county="*", tract="*"),
  endyear = 2012, span = 5,
  table.number = "B19001",
  col.names = "pretty"
)

names(attributes(fetched))
attr(fetched, "acs.colnames")

acs_df <- data.frame(
  paste0(
    str_pad(fetched@geography$state, 2, "left", pad="0"),
    str_pad(fetched@geography$county, 3, "left", pad="0"),
    str_pad(fetched@geography$tract, 6, "left", pad="0")),
  fetched@estimate[,c("Household Income: Total:", "Household Income: $200,000 or more")],
  stringsAsFactors = FALSE)

  
acs_df           <- select(acs_df, 1:3) %>% tbl_df()
rownames(acs_df) <- 1:nrow(acs_df)
names(acs_df)    <- c("GEOID", "total", "over_200")
acs_df$percent   <- 100*(acs_df$over_200/acs_df$total)
```

```{r}
df_merged <- geo_join(tracts, acs_df, "GEOID", "GEOID")

# there are some tracts with no land that we should exclude
df_merged <- df_merged[df_merged$ALAND>0,]
```

```{r}
popup <- paste0("GEOID: ", df_merged$GEOID, "<br>", "Percent of Households above $200k: ", round(df_merged$percent,2))
pal <- colorNumeric(
  palette = "YlGnBu",
  domain = df_merged$percent
)
```

```{r}
leaflet() %>%
  addProviderTiles("CartoDB.Positron") %>%
  addPolygons(data = df_merged, 
              fillColor = ~pal(percent), 
              color = "#b2aeae", # you need to use hex colors
              fillOpacity = 0.7, 
              weight = 1, 
              smoothFactor = 0.2,
              popup = popup) %>%
  addLegend(pal = pal, 
            values = df_merged$percent, 
            position = "bottomright", 
            title = "Percent of Households<br>above $200k",
            labFormat = labelFormat(suffix = "%")) 
```

```{r}
library(rgdal)
cleanup <- theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_rect(fill = 'white', colour = 'white'),
        axis.line = element_line(colour = "white"), legend.position="none",
        axis.ticks=element_blank(), axis.text.x=element_blank(),
        axis.text.y=element_blank())
towntracts <- readOGR(dsn="chicago_tracts_2010", layer="geo_export_9588a35d-8dfa-4dd9-9d49-6cdfc941d52b")
gg <- ggplot()
gg <- gg + geom_polygon(data=towntracts, aes(x=long, y=lat, group=group), colour="black", fill="grey90", size=0.5) 
gg <- gg + stat_density2d(data=Crime, show.legend=F, aes(x=Longitude, y=Latitude, fill=..level.., alpha=..level..), geom="polygon", size=2, bins=10)
gg <- gg + scale_fill_gradient(low="deepskyblue2", high="firebrick1", name="Distribution")
#gg <- gg +  coord_map("polyconic")
gg <- gg + labs(x=NULL, y=NULL,
                  title="Crime Rates in Chicago",
                  subtitle=NULL,
                  caption="Source: data.ct.gov")
gg <- gg + cleanup
gg
```

```{r}
Crime_2010 <- Crime %>% filter(Year == 2010)
gg2010 <- ggplot()
gg2010 <- gg2010 + geom_polygon(data=towntracts, aes(x=long, y=lat, group=group), colour="black", fill="grey90", size=0.5) 
gg2010 <- gg2010 + stat_density2d(data=Crime_2010, show.legend=F, aes(x=Longitude, y=Latitude, fill=..level.., alpha=..level..), geom="polygon", size=2, bins=10)
gg2010 <- gg2010 + scale_fill_gradient(low="deepskyblue2", high="firebrick1", name="Distribution")
#gg <- gg +  coord_map("polyconic")
gg2010 <- gg2010 + labs(x=NULL, y=NULL,
                  title="Crime Rates in Chicago",
                  subtitle=NULL,
                  caption="Source: data.ct.gov")
gg2010 <- gg2010 + cleanup
gg2010

Crime_2013 <- Crime %>% filter(Year == 2013)
gg2013 <- ggplot()
gg2013 <- gg2013 + geom_polygon(data=towntracts, aes(x=long, y=lat, group=group), colour="black", fill="grey90", size=0.5) 
gg2013 <- gg2013 + stat_density2d(data=Crime_2013, show.legend=F, aes(x=Longitude, y=Latitude, fill=..level.., alpha=..level..), geom="polygon", size=2, bins=10)
gg2013 <- gg2013 + scale_fill_gradient(low="deepskyblue2", high="firebrick1", name="Distribution")
#gg <- gg +  coord_map("polyconic")
gg2013 <- gg2013 + labs(x=NULL, y=NULL,
                  title="Crime Rates in Chicago",
                  subtitle=NULL,
                  caption="Source: data.ct.gov")
gg2013 <- gg2013 + cleanup
gg2013


Crime_2016 <- Crime %>% filter(Year == 2016)
gg2016 <- ggplot()
gg2016 <- gg2016 + geom_polygon(data=towntracts, aes(x=long, y=lat, group=group), colour="black", fill="grey90", size=0.5) 
gg2016 <- gg2016 + stat_density2d(data=Crime_2016, show.legend=F, aes(x=Longitude, y=Latitude, fill=..level.., alpha=..level..), geom="polygon", size=2, bins=10)
gg2016 <- gg2016 + scale_fill_gradient(low="deepskyblue2", high="firebrick1", name="Distribution")
#gg <- gg +  coord_map("polyconic")
gg2016 <- gg2016 + labs(x=NULL, y=NULL,
                  title="Crime Rates in Chicago",
                  subtitle=NULL,
                  caption="Source: data.ct.gov")
gg2016 <- gg2016 + cleanup
gg2016
```


```{r, fig.width=15, fig.height=15}
library(rgdal)

gg1 <- ggplot()
gg1 <- gg1 + geom_polygon(data=towntracts, aes(x=long, y=lat, group=group), colour="black", fill=NA, size=0.5, alpha=0.5) 
gg1 <- gg1 + stat_density2d(data=Crime, show.legend=F, aes(x=Longitude, y=Latitude, fill=..level.., alpha=..level..), geom="polygon", size=2, bins=10)
gg1 <- gg1 + scale_fill_gradient(low="deepskyblue2", high="firebrick1", name="Distribution")
#gg1 <- gg1 +  coord_map("polyconic") 
gg1 <- gg1 + facet_wrap(~Location.Description)
gg1 <- gg1 + labs(x=NULL, y=NULL, 
                  title="Crime Rates in Cook County",
                  subtitle=NULL,
                  caption="Source: data.ct.gov")
gg1 <- gg1 + cleanup
gg1
```

```{r, fig.width=15, fig.height=15}
library(rgdal)

gg2 <- ggplot()
gg2 <- gg2 + stat_density2d(data=Crime, show.legend=F, aes(x=Longitude, y=Latitude, fill=..level.., alpha=..level..), geom="polygon", size=2, bins=10)
gg2 <- gg2 + geom_polygon(data=towntracts, aes(x=long, y=lat, group=group), colour="black", fill=NA, size=0.5) 
gg2 <- gg2 + scale_fill_gradient(low="deepskyblue2", high="firebrick1", name="Distribution")
gg2 <- gg2 + coord_map("polyconic") 
gg2 <- gg2 + facet_wrap(~Primary.Type)
gg2 <- gg2 + labs(x=NULL, y=NULL, 
                  title="Crime Rates in Cook County",
                  subtitle=NULL,
                  caption="Source: data.ct.gov")
gg2 <- gg2 + cleanup
gg2
```


```{r}
library(choroplethr)
library(choroplethrMaps)
library(mapproj)
library(ggplot2)

#install.packages("devtools")
library(devtools)
install_github('arilamstein/choroplethrZip@v1.5.0')

library(choroplethrZip)


data(df_pop_zip)
data(df_zip_demographics)

zip_percent_white <- df_zip_demographics[c("region", "percent_white")]
colnames(zip_percent_white)[2] <- "value"

zip_percent_black <- df_zip_demographics[c("region", "percent_black")]
colnames(zip_percent_black)[2] <- "value"

zip_percent_asian <- df_zip_demographics[c("region", "percent_asian")]
colnames(zip_percent_asian)[2] <- "value"

zip_percent_hispanic <- df_zip_demographics[c("region", "percent_hispanic")]
colnames(zip_percent_hispanic)[2] <- "value"

zip_per_capita_income <- df_zip_demographics[c("region", "per_capita_income")]
colnames(zip_per_capita_income)[2] <- "value"

zip_median_rent <- df_zip_demographics[c("region", "median_rent")]
colnames(zip_median_rent)[2] <- "value"

zip_median_age <- df_zip_demographics[c("region", "median_age")]
colnames(zip_median_age)[2] <- "value"

#-------------------------------------------

data(zip.regions)
chi_nap_elg <- subset(zip.regions, zip.regions$cbsa.title=="Chicago-Naperville-Elgin, IL-IN-WI")
cook_county <- subset(chi_nap_elg, chi_nap_elg$county.name == "cook")
cook_fips <- cook_county$county.fips.numeric


zip_choropleth(df_pop_zip, 
               county_zoom = cook_fips, 
               title="Population of Cook County") + coord_map()
zip_choropleth(zip_percent_white, 
               county_zoom = cook_fips, 
               title="White Population of Cook County") + coord_map()
zip_choropleth(zip_percent_black, 
               county_zoom = cook_fips, 
               title="Black Population of Cook County") + coord_map()
zip_choropleth(zip_percent_asian, 
               county_zoom = cook_fips, 
               title="Asian Population of Cook County") + coord_map()
zip_choropleth(zip_percent_hispanic, 
               county_zoom = cook_fips, 
               title="Hispanic Population of Cook County") + coord_map()
zip_choropleth(zip_per_capita_income, 
               county_zoom = cook_fips, 
               title="Per Capita Income of Cook County") + coord_map()
zip_choropleth(zip_median_rent, 
               county_zoom = cook_fips, 
               title="Median Rent of Cook County") + coord_map()
zip_choropleth(zip_median_age, 
               county_zoom = cook_fips, 
               title="Median Age of Cook County") + coord_map()
```


# Choropleth of crime

```{r}

#library(scales)
towntracts_shp <- towntracts
towntracts_df <- fortify(towntracts, region = "geoid10")
crime_types = levels(Crime$Primary.Type)

#check the CRS of the shapefile and coordinates
locations <- with(Crime, as.data.frame(cbind(Longitude, Latitude)))
locations <- locations[!is.na(locations$Longitude),]
coordinates(locations) <- ~Longitude+Latitude
proj4string(locations) <- CRS("+init=epsg:4326")
print(locations@proj4string)
print(towntracts_shp@proj4string)

#needs to reassign CRS for shapefile
new_CRS <- CRS("+init=epsg:4326 +proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0")
towntracts_shp <- sp::spTransform(towntracts_shp, new_CRS)



for (i in 1:length(crime_types)){
  #filter for current crime type
  current_type = crime_types[i]
  Current_Crimes = Crime %>% filter(Primary.Type == current_type)
  
  #get the coordinates
  locations <- with(Current_Crimes, as.data.frame(cbind(Longitude, Latitude)))
  locations <- locations[!is.na(locations$Longitude),]
  if (nrow(locations) > 0){
    coordinates(locations) <- ~Longitude+Latitude
    proj4string(locations) <- CRS("+init=epsg:4326")
    
    
    #prepping the data: project points to polygons
    proj4string(towntracts_shp) <- new_CRS
    proj4string(locations) <- new_CRS
    by_tract <- over(locations, towntracts_shp)
    by_tract <- by_tract %>%
      group_by(geoid10) %>%
      dplyr::summarise(total=n()) %>%
      filter(!is.na(geoid10)) %>%
      mutate(id = as.character(geoid10))
    
    #making choropleth
    total_map <- left_join(towntracts_df, by_tract)
    total_map$total[is.na(total_map$total)] <- 0 
    hamden_ts <- ggplot() 
    hamden_ts <- hamden_ts +  geom_polygon(data = total_map, aes(x=long, y=lat, group=group, fill=total), color = "black", size=0.2) 
    hamden_ts <- hamden_ts + coord_map() 
    hamden_ts <- hamden_ts + labs(title=paste("Crimes of type", toString(current_type), sep=" "), fill="total")
    hamden_ts <- hamden_ts +  theme_nothing(legend=TRUE) 
    print(hamden_ts)
  }
  

}



```

