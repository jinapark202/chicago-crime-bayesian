---
title: "Models Update"
author: "Jina Park, Phuc Nguyen"
date: "12/5/2017"
output: html_document
---

### Research Question 1

- Predicting hotspots of specific crimes and how they changed over time and space.

- How have these hotspots changed over time? If they have changed over time, how has it changed relative to changes in income, demographics, age, etc?

- Are the hotspots of violent crimes different than the hotspots of non-violent crime? What kinds of locations are these types of crimes more concentrated in?

#### Load Libraries
```{r message=FALSE, warning=FALSE}
library(tidyr)
library(rjags)
library(ggplot2)
library(dplyr)
library(tidyverse)
library(MacBayes)
library(choroplethrZip)
library(rgdal)
```

#### Map cleanup
```{r}
cleanup <- theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_rect(fill = 'white', colour = 'white'),
        axis.line = element_line(colour = "white"),
        axis.ticks=element_blank(), axis.text.x=element_blank(),
        axis.text.y=element_blank())
```

#### Clean data
```{r}
#Load data
Crime = read.csv('Crime_sample_2010_to_2017.csv')

Crime = Crime %>%
  mutate(Date = as.POSIXct(strptime(Date, "%Y-%m-%d %H:%M:%S"))) %>%
  filter(!is.na(Latitude))
```

#### Project observations to ZIP codes boundaries
```{r message=FALSE, warning=FALSE}
#load shapefile
zip_shp <- readOGR(dsn="Boundaries - ZIP Codes", layer="geo_export_e1262361-5c82-45ee-8427-ef228e06dc4a")
temp <- zip_shp
zip_df <- fortify(temp, region = "zip")

#needs to reassign CRS for shapefile
new_CRS <- CRS("+init=epsg:4326 +proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0")
zip_shp <- sp::spTransform(zip_shp, new_CRS)

#summarize crime count per year
years <- unique(Crime$Year)
Hotspot_Crime <- data.frame()

for(i in 1:length(years)){
  year <- years[i]
  Current_Year <- Crime %>% filter(Year == year)
  
  locations <- with(Current_Year, as.data.frame(cbind(Longitude, Latitude)))
  coordinates(locations) <- ~Longitude+Latitude
  proj4string(locations) <- CRS("+init=epsg:4326")
      
  #prepping the data: project points to polygons
  proj4string(zip_shp) <- new_CRS
  proj4string(locations) <- new_CRS
  by_zip <- over(locations, zip_shp)
  
  by_zip <- by_zip %>%
    group_by(zip) %>%
    dplyr::summarise(total=n()) %>%
    filter(!is.na(zip)) %>%
    mutate(id = as.character(zip))
  
  total_map <- left_join(zip_df, by_zip)
  total_map <- total_map %>% mutate(Year = year)
  
  Hotspot_Crime <- rbind(Hotspot_Crime, total_map)
}
```

#### Add demographic information to Model Data
```{r}
data("df_zip_demographics")
Demographics <- df_zip_demographics %>% mutate(zip = region)
Hotspot_Crime <- inner_join(Hotspot_Crime, Demographics, by="zip") 
Model_Data <- Hotspot_Crime %>%
  select(-c(lat, long, order, piece, group, hole)) %>% distinct
```

#### Nested data: crime counts, population, standardized year 
```{r}
Model_Data <- transform(Model_Data, zipid=match(zip, unique(zip)))
Model_Data$time = Model_Data$Year-2009
Model_Data$racegr <- ifelse(Model_Data$percent_white >80, 1, 
                            ifelse(Model_Data$percent_white <=80 & Model_Data$percent_white > 60,2,
                            ifelse(Model_Data$percent_white <=60 & Model_Data$percent_white > 40,3,
                            ifelse(Model_Data$percent_white <=40 & Model_Data$percent_white > 20,4, 5)))) 
Model_Data$income = scale(Model_Data$per_capita_income)[,1]

write.csv(Model_Data, "Crime_models_data.csv")
```

### Load Data:
```{r}
Model_Data = read.csv("Crime_models_data.csv")
```

---------------------------------------------------------------

#### Simulation
# Research Question 1

**Plot of $log(y_{ij}/n_{i})$ vs year**
```{r, cache=TRUE}
Crime_count_log <- Model_Data %>%
  mutate(log_rate = log(total/total_population)) %>%
  select(zip, Year, log_rate)
head(Crime_count_log)

ggplot(Crime_count_log, aes(x=Year, y=log_rate, colour=zip)) + geom_point() + geom_line()  + labs(title="Crime Rate Over Time", y="Log of Crime Rate", x="Year", color=" ")
```

**Plot of $log(y_{ij}/n_{i})$ vs per capita income**
```{r}
Model_Data_1 <- Model_Data %>%
  filter(Year == 2010) %>%
  mutate(percent_nonwhite = 100 - percent_white) %>%
  select(zip, per_capita_income, percent_nonwhite) %>%
  right_join(Crime_count_log, by="zip") 

ggplot(Model_Data_1, aes(x=log(per_capita_income), y=log_rate, colour=percent_nonwhite)) + geom_point() + labs(x="Log of Per Capita Income", y="Log of Crime Rate", title="Relationship between Per Capita Income and Crime Rate", color="Nonwhite Percentage") 
```

**Plot of $log(y_{ij}/n_{i})$ vs nonwhite percentage**
```{r}
ggplot(Model_Data_1, aes(x=log(percent_nonwhite), y=log_rate, colour=per_capita_income)) + geom_point() + labs(x="Log of Nonwhite Percentage", y="Log of Crime Rate", title="Relationship between Nonwhite Percentage and Log of Crime Rate")
```

## Model 0
#### Data
$$y_{ij} \sim Bin(p_{ij}, n_{i})$$
$$logit(p_{ij}) = \beta * time_{j}$$

#### Priors
$$\beta \sim N(0, 1000^2)$$

- i: zipcodes in Chicago (58 total in our data)

- j: years (from 2010 to 2017)

- y[i, j]: observed count of violent crimes in Chicago by year and zipcode

- p[i, j]: probability of being a victim in location i and time j

- n[i]: the population in zipcode i

- $\beta$: time trend

- time[j]: the time in years

```{r, cache=TRUE}
#Specify the model
crime_model_0 <- "model{
    #Data
    for(j in 1:ns){
      y[j] ~ dbin(p[j], n[j])
      logit(p[j]) = alpha + beta*time[j]
    }
    
    #Priors
    beta ~ dnorm(0, 1/1000^2)
    alpha ~ dnorm(0, 1/1000^2)

}"

#set up an algorithm to simulate the posterior by 
#combining the model (nba_model) and data (y)
#set the random number seed
crime_jags_0 <- jags.model(textConnection(crime_model_0), data=list(y=Model_Data$total, n=Model_Data$total_population, time=Model_Data$time, ns=nrow(Model_Data)),inits=list(.RNG.name="base::Wichmann-Hill", .RNG.seed=1989))


#simulate a sample from the posterior 
crime_sim_0 <- coda.samples(crime_jags_0, variable.names=c("beta", "alpha"), n.iter=20000)

#store the samples in a data frame:    
crime_data_0 <- data.frame(crime_sim_0[[1]])
```

### Check for convergence
```{r}
#check for convergece
#from: https://rpubs.com/corey_sparks/32494
init.rng1<-list(".RNG.seed" = 1234, ".RNG.name" = "base::Mersenne-Twister")
init.rng2<-list(".RNG.seed" = 5678, ".RNG.name" = "base::Mersenne-Twister")
mod<-jags.model(file=textConnection(crime_model_0),list(y=Model_Data$total, n=Model_Data$total_population, time=Model_Data$time, ns=nrow(Model_Data)),inits =list(init.rng1, init.rng2) , n.chains=2)
update(mod, 10000)
samps<-coda.samples(mod, variable.names=c("beta","alpha"), n.iter=5000, n.thin=5)
gelman.diag(samps)

#running mean plot
running_mean_plot(crime_data_0$beta)
running_mean_plot(crime_data_0$alpha)
```

### Parameter Inferences
#### Posterior Distribution Plots
```{r}
ggplot(crime_data_0, aes(x=beta)) + geom_histogram(aes(y=..density..), colour="white") + labs(title="Posterior Distribution of the Effect of Time", x="Time Effect", y="Density")

ggplot(crime_data_0, aes(x=alpha)) + geom_histogram(aes(y=..density..), colour="white") + labs(title="Posterior Distribution of Intercept", x="Time Effect", y="Density")
```

#### Confidence Intervals and Posterior Means of Crime Model 0 Parameters
```{r}
crime_model_0_CI <- matrix(nrow=2, ncol=2)

for (i in 1:2) {
      crime_model_0_CI[i,] <- quantile(crime_data_0[[i]], c(0.025, 0.975))
}

crime_model_0_mean <- matrix(nrow=2, ncol=1)
for (i in 1:2) {
      crime_model_0_mean[i, ] <- mean(crime_data_0[[i]])
}

crime_model_0_table <- cbind(crime_model_0_CI, crime_model_0_mean)
rownames(crime_model_0_table) <- names(crime_data_0)
colnames(crime_model_0_table) <- c("2.5%", "97.5%", "Mean")
# as.table(crime_model_0_table)
```

## Model 1
### Notation
- i: zipcodes in Chicago (58 total in our data)

- j: years (from 2010 to 2017)

- y[i, j]: observed count of violent crimes in Chicago by year and zipcode

- p[i, j]: probability of being a victim in location i and time j

- n[i, j]: the population in zipcode i in time j.

- time[j]: the time in years

- $\delta$[i]: the spatial temporal interaction term

### Specify the Model
We are modeling the count of crime incidents by year and zipcodes using a binomial distribution, in which the parameters are the probability of being a victim and the total population in location i and year j.

We modeled the probability of being a victim using a logit function of the grand crime rate of Chicago and the inclusion of several random effects. It is also a function of time and its interaction with location.

#### Data
$$y_{ij} \sim Bin(p_{ij}, n_{i})$$
$$logit(p_{ij}) = \beta_{i} + \delta_{i} * time_{j}$$

#### Priors
$$\beta_{i} \sim N(0, \tau_{0})$$
$$\delta_{i} \sim N(0, \tau_{1})$$

#### Hyperpriors
$$\tau_0 \sim Gamma(0.5, 0.0005)$$

$$\tau_1 \sim Gamma(0.5, 0.0005)$$

```{r, cache=TRUE}
#Data
data = list(y=Model_Data$total, n=Model_Data$total_population, time=Model_Data$time, zipid=Model_Data$zipid, ns=length(Model_Data$total), nzip=length(unique(Model_Data$id)))
```

```{r, cache=TRUE}
#Specify the model
crime_model_1 <- "model{
    #Data
    for(i in 1:ns) {
      y[i] ~ dbin(p[i], n[i])
      logit(p[i]) = beta[zipid[i]] + delta[zipid[i]]*time[i]
    }
    
    #Priors
    for(j in 1:nzip){
      delta[j] ~ dnorm(delta0, tau_1)
      beta[j] ~ dnorm(beta0, tau_0)
    }
    beta0 ~ dnorm(0, 1/1000^2)
    delta0 ~ dnorm(0, 1/1000^2)

    #Hyperpriors
    tau_0 ~ dgamma(0.5, 0.0005)
    tau_1 ~ dgamma(0.5, 0.0005)
    
}"

#set up an algorithm to simulate the posterior
#set the random number seed
init.rng1<-list(".RNG.seed" = 1998, ".RNG.name" = "base::Mersenne-Twister")
crime_jags_1 <- jags.model(textConnection(crime_model_1), data=data,
                    inits=init.rng1)


#simulate a sample from the posterior 
crime_sim_1 <- coda.samples(crime_jags_1, variable.names=c("delta", "beta", "tau_0", "tau_1"), n.iter=30000)


#store the samples in a data frame:    
crime_data_1 <- data.frame( crime_sim_1[[1]])

write.csv()
```

### Check for convergence
```{r}
#check for convergece
#from: https://rpubs.com/corey_sparks/32494
init.rng1<-list(".RNG.seed" = 1234, ".RNG.name" = "base::Mersenne-Twister")
init.rng2<-list(".RNG.seed" = 5678, ".RNG.name" = "base::Mersenne-Twister")
mod<-jags.model(file=textConnection(crime_model_1), data=data,inits =list(init.rng1, init.rng2) , n.chains=2)
samps<-coda.samples(mod, variable.names=c("delta", "beta", "tau_0", "tau_1","beta0", "delta0"), n.iter=5000, n.thin=5)
gelman.diag(samps)


running_mean_plot(crime_data_1$delta.1.)
running_mean_plot(crime_data_1$beta.1.)
running_mean_plot(crime_data_1$tau_0)
running_mean_plot(crime_data_1$tau_1)
```

### Parameter Interpretation
#### Posterior Distribution
```{r}
ggplot(crime_data_1, aes(x=delta.1.)) + geom_histogram(aes(y=..density..), colour="white") + labs(title="Posterior Distribution of the Crime Differential Growth in 2010", x="Crime Differential Growth", y="Density")
```

### Confidence Intervals and Posterior Means of Crime Model 1 Parameters

**Check for posterior significance**
```{r}
summary(crime_sim_1)
```

```{r}
n = length(unique(Model_Data$zip))

#posterior mean and quantile of delta only

crime_model_1_CI <- matrix(nrow=n, ncol=2)
for (i in 1:n) {
      crime_model_1_CI[i, ] <- quantile(crime_data_1[[i+n]], c(0.025, 0.975))
}

crime_model_1_mean <- matrix(nrow=n, ncol=1)

for (i in 1:n) {
      crime_model_1_mean[i, ] <- mean(crime_data_1[[i+n]])
}

crime_model_1_table <- cbind(crime_model_1_CI, crime_model_1_mean)
rownames(crime_model_1_table) <- names(crime_data_1)[59:116]
colnames(crime_model_1_table) <- c("2.5%", "97.5%", "Mean")
as.table(crime_model_1_table)
```

The 95% confidence interval for $\beta$ is (-0.004096, 0.0002897). Since $\beta$ is not considered signifant in the 5% level, we can proceed with Model 2 instead, in which the overall time trend is removed from the model.

## Crime Model 1 Visualizations

### Map of Crime Differential Growth by Zipcode (Using Model 1)
```{r, cache=TRUE}
zip <- readOGR(dsn="Boundaries - ZIP Codes", layer="geo_export_e1262361-5c82-45ee-8427-ef228e06dc4a")
zip_df <- fortify(zip, region = "zip")
crime_model_1_delta <- left_join(zip_df, data.frame(id=as.character(unique(Model_Data$zip)), delta=crime_model_1_mean), by='id')

model_1_map <- ggplot() 
model_1_map <- model_1_map +  geom_polygon(data = crime_model_1_delta, aes(x=long, y=lat, group=group, fill=delta), color = "black", size=0.2) 
model_1_map <- model_1_map + coord_map() 
model_1_map <- model_1_map + labs(x="", y="", title=paste("Crime Differential Growth by Zipcode"), caption="Model 1", fill="Trend over Time")
model_1_map <- model_1_map + cleanup + scale_fill_gradient(low = "blue", high = "orange")
print(model_1_map)
```

### Variability of the Crime Differential Growth
```{r}
sqrt(1/mean(crime_data_1$tau_1))
```

```{r, cache=TRUE}
ggplot(crime_model_1_delta, aes(x=delta)) + geom_histogram(colour="white") + labs(x="Crime Differential Growth", y="Count", title="Histogram of Crime Differential Growth")
```

------------------------------------------------------------------------------

# Model 2 -- Use demographics information 

### Notation
- i: zipcodes in Chicago (58 total in our data)

- j: years (from 2010 to 2017)

- y[i, j]: observed count of violent crimes in Chicago by year and zipcode

- p[i, j]: probability of being a victim in location i and time j

- n[i, j]: the population in zipcode i in time j.

- time[j]: the time in years

- $\delta$[i]: the spatial temporal interaction term

- $\sigma$[i]: the income trend

- income[i]: income for each zipcode in Chicago

### Specify the Model
This model resembles Model 2 but now our prediction of the crime rate accounts for the different income levels in various Chicago zipcodes.

#### Data

$$y_{ij} \sim Bin(p_{ij}, n_{i})$$
$$logit(p_{ij}) = \beta_{i} + \sigma_{j} * income_{i}$$

#### Priors
$$\beta_{i} \sim N(0, \tau_{0})$$
$$\sigma_{j} \sim N(0, \tau_{1})$$

#### Hyperprior

$$\tau_{0} \sim Gamma(0.5, 0.0005)$$
$$\tau_{1} \sim Gamma(0.5, 0.0005)$$


$$\[\hat{y} = \beta_0 + \beta_1 x_1 + \beta_2 x_2 + \beta_{1\times 2} x_1 x_2 \] $$

```{r}
Model2_Data <- Model_Data #%>% filter(Year==2010)
temp <- Model_Data %>% filter(!duplicated(zipid))
data = list(y=Model2_Data$total, 
            n=Model2_Data$total_population, 
            zipid=Model2_Data$zipid, 
            racegr=Model2_Data$racegr, 
            income=Model2_Data$income, 
            ns=nrow(Model2_Data), 
            time=Model2_Data$time, 
            nzip=length(unique(Model2_Data$zip)),
            raceid = temp$racegr,
            incomezip = temp$income)
```

```{r, cache=TRUE, message=FALSE, warning=FALSE}
#Specify the model
crime_model_2 <- "model{
    #Data
    for(i in 1:ns) {
      y[i] ~ dbin(p[i], n[i])
      logit(p[i]) = beta[zipid[i]] + delta[zipid[i]]*time[i] 
    }
    
    #Priors
    for(i in 1:nzip){
      beta[i] ~ dnorm(beta0 + sigma[raceid[i]]*incomezip[i], tau_0)
      delta[i] ~ dnorm(delta0, tau_1)
    }
    beta0 ~ dnorm(0, 1/1000^2)
    delta0 ~ dnorm(0, 1/1000^2)
    sigma0 ~ dnorm(0, 1/1000^2)
    for(j in 1:5){
      sigma[j] ~ dnorm(sigma0, tau_2)
    }

    #Hyperpriors
    tau_0 ~ dgamma(0.5, 0.0005)
    tau_1 ~ dgamma(0.5, 0.0005)
    tau_2 ~ dgamma(0.5, 0.0005)
    
}"

#set up an algorithm to simulate the posterior by 
#combining the model (nba_model) and data (y)
#set the random number seed
crime_jags_2 <- jags.model(textConnection(crime_model_2), data=data,
                    inits=list(.RNG.name="base::Wichmann-Hill", .RNG.seed=1989))


#simulate a sample from the posterior 
#note that we specify both mu and tau variables
crime_sim_2 <- coda.samples(crime_jags_2, variable.names=c("beta", "beta0", "delta", "delta0","sigma","sigma0", "tau_0","tau_1","tau_2"), n.iter=50000)


#store the samples in a data frame:    
crime_data_2 <- data.frame(crime_sim_2[[1]])
```

```{r}
running_mean_plot(crime_data_2$beta.1.)
running_mean_plot(crime_data_2$beta0)
running_mean_plot(crime_data_2$sigma.2.)
running_mean_plot(crime_data_2$sigma0)
running_mean_plot(crime_data_2$delta.1.)
running_mean_plot(crime_data_2$tau_0)
running_mean_plot(crime_data_2$tau_1)
running_mean_plot(crime_data_2$tau_2)

```

### Check for convergence
```{r}
#check for convergece
#from: https://rpubs.com/corey_sparks/32494
init.rng1<-list(".RNG.seed" = 1234, ".RNG.name" = "base::Mersenne-Twister")
init.rng2<-list(".RNG.seed" = 5678, ".RNG.name" = "base::Mersenne-Twister")
mod<-jags.model(file=textConnection(crime_model_2), data=data,inits =list(init.rng1, init.rng2) , n.chains=2)
samps<-coda.samples(mod, variable.names=c("sigma", "tau_0","beta","tau_1", "tau_2", "delta", "beta0", "delta0", "sigma0", "alpha"), n.iter=5000, n.thin=5)
gelman.diag(samps)
effectiveSize(samps)
```


## Crime Model 2 Visualizations

```{r}
posterior_means <- crime_data_2 %>% colMeans()
posterior_means
crime_model_2_sigma <- Model_Data
crime_model_2_sigma$beta <- recode(crime_model_2_sigma$racegr, `1`=posterior_means[1],
                                   `2`=posterior_means[2],
                                   `3`=posterior_means[3],
                                   `4`=posterior_means[4],
                                   `5`=posterior_means[5])
crime_model_2_sigma$sigma <- recode(crime_model_2_sigma$racegr, `1`=posterior_means[6],
                                   `2`=posterior_means[7],
                                   `3`=posterior_means[8],
                                   `4`=posterior_means[9],
                                   `5`=posterior_means[10])
crime_model_2_sigma <- crime_model_2_sigma %>%
  mutate(id = as.character(zip)) %>%
  right_join(zip_df, by="id")
```


### Income Differential Growth by Zipcode (Using Model 2)
```{r, cache=TRUE}
model_2_map <- ggplot() 
model_2_map <- model_2_map +  geom_polygon(data = crime_model_2_sigma, aes(x=long, y=lat, group=group, fill=sigma), color = "black", size=0.2) 
model_2_map <- model_2_map + coord_map() 
model_2_map <- model_2_map + labs(x="", y="", title=paste("Crime Differential Growth Based on Income and Demographics"), caption="Model 2", fill="Trend over Time")
model_2_map <- model_2_map + cleanup + scale_fill_gradient(low = "blue", high = "orange")
print(model_2_map)

posterior_means
#Five groups, 20% increase in percent white. Darkest blue is the areas with 20% or lower of population white.
#See Posterior means
```

In locations where the income differential growth increases, the crime differential growth seems to decrease.

---------------------------------------------------------------

## Model 3 -- Use demographics information with race

### Notation
- i: zipcodes in Chicago (58 total in our data)

- j: years (from 2010 to 2017)

- y[i, j]: observed count of violent crimes in Chicago by year and zipcode

- p[i, j]: probability of being a victim in location i and time j

- n[i, j]: the population in zipcode i in time j.

- time[j]: the time in years

- $\delta$[i]: the spatial temporal interaction term

- $\sigma$[i]: the income trend

- income[i]: income for each zipcode in Chicago

- $\rho$[i]: the weight in the relationship between crime rate and percentage of nonewhite people in Chicago

- percent_nonwhite[i]: the percentage of nonwhite people in zipcode i.

### Specify the Model
This model resembles Model 3 but now our prediction of the crime rate accounts for both income levels and the percentage of nonwhites in the area.

#### Data
$$y_{ij} \sim Bin(p_{ij}, n_{i})$$
$$logit(p_{ij}) =  \delta_{i} * time_{j} + \sigma_{i} * income_{i} + \rho_{i} * percentNonwhite_{i}$$

#### Priors
$$\delta_{i} \sim N(0, \tau_{1})$$
$$\sigma_{i} \sim N(0, tau_{2})$$
$$\rho_{i} \sim N(0, 0.01)$$

#### Hyperprior
$$\tau_{1} \sim Gamma(0.5, 0.0005)$$
$$\tau_{2} \sim Gamma(0.5, 0.0005)$$
$$\tau_{3} \sim Gamma(0.5, 0.0005)$$

```{r}
train_data <- Model_Data %>%
  filter(Year != 2016)
temp <- train_data %>% filter(!duplicated(zipid))
#project income onto percent white vector
decomp <- qr(cbind(temp$income, temp$percent_white, temp$income*temp$percent_white))
Q <- qr.Q(decomp)
R <- qr.R(decomp)
data = list(ns=nrow(train_data), 
            y=train_data$total, 
            n=train_data$total_population,
            time=train_data$time, 
            nzip=length(unique(train_data$zipid)), 
            zipid=train_data$zipid, 
            incomezip=Q[,1], 
            whitezip=Q[,2],
            interactionzip = Q[,3])
```

```{r, cache=TRUE, message=FALSE, warning=FALSE}
#Specify the model
crime_model_3 <- "model{
    #Data
    for(i in 1:ns) {
      y[i] ~ dbin(p[i], n[i])
      logit(p[i]) = beta[zipid[i]] + delta[zipid[i]]*time[i] 
    }
    
    #Priors
    beta0 ~ dnorm(0, 1/1000^2)
    delta0 ~ dnorm(0, 1/1000^2)
    for(i in 1:nzip){
      beta[i] ~ dnorm(beta0 + sigma[1]*incomezip[i] + sigma[2]*whitezip[i] + sigma[3]*interactionzip[i], tau_0)
      delta[i] ~ dnorm(delta0, tau_1)
    }
    for(i in 1:3){
      sigma[i] ~ dnorm(0, 1/1000^2)
    }
    tau_0 ~ dgamma(0.5, 0.0005)
    tau_1 ~ dgamma(0.5, 0.0005)
    
}"

#set up an algorithm to simulate the posterior by 
#combining the model (nba_model) and data (y)
#set the random number seed
crime_jags_3 <- jags.model(textConnection(crime_model_3), data=data,
                    inits=list(.RNG.name="base::Wichmann-Hill", .RNG.seed=1989))


#simulate a sample from the posterior 
#note that we specify both mu and tau variables
crime_sim_3 <- coda.samples(crime_jags_3, variable.names=c("beta","delta", "sigma"), n.iter=60000)

#store the samples in a data frame:    
crime_data_3 <- data.frame(crime_sim_3[[1]])
```

### Check for convergence
```{r}
#check for convergece
#from: https://rpubs.com/corey_sparks/32494
init.rng1<-list(".RNG.seed" = 1234, ".RNG.name" = "base::Mersenne-Twister")
init.rng2<-list(".RNG.seed" = 5678, ".RNG.name" = "base::Mersenne-Twister")
mod<-jags.model(file=textConnection(crime_model_3), data=data,inits =list(init.rng1, init.rng2) , n.chains=2)
samps<-coda.samples(mod, vahriable.names=c("beta", "beta0", "delta", "delta0","tau_0", "tau_1", "sigma"), n.iter=5000, n.thin=5)
gelman.diag(samps)
effectiveSize(samps)
```

### Mean of parameters from Model 3
```{r}
head(crime_data_3)
crime_data_3 <- crime_data_3[20000:nrow(crime_data_3), ]
crime_data_3_sum <- as.data.frame(colMeans(crime_data_3))
crime_data_3_sum
```

```{r}
test_data <- Model_Data %>%
  filter(Year == 2016)
```

### Function to predict crime rate given parameters
```{r}
model_3_predictor <- function(param, income, percent_nonwhite, year, population){
   c <- (param[1,1] + param[2,1] * year + param[3,1] * income + param[4,1] * percent_nonwhite + param[5,1] * percent_nonwhite * income)
   p <- exp(c)/(1 + exp(c))
   return(p * population)
 }
```

### Predicted Crime Count
```{r}
predicted_crime_count <- model_3_predictor(crime_data_3_sum, test_data$income, test_data$percent_white, test_data$time, test_data$total_population)

actual_crime_count <- test_data$total 
crime_count_diff <- predicted_crime_count - actual_crime_count
```

### Map of Crime Count Difference by Zipcode (Using Model 3)
```{r, cache=TRUE}
zip <- readOGR(dsn="Boundaries - ZIP Codes", layer="geo_export_e1262361-5c82-45ee-8427-ef228e06dc4a")
zip_df <- fortify(zip, region = "zip")
crime_model_3_count_diff <- left_join(zip_df, data.frame(id=as.character(unique(test_data$zip)), crime_difference=crime_count_diff), by='id')
head(crime_model_3_count_diff)

model_3_map <- ggplot() 
model_3_map <- model_3_map +  geom_polygon(data = crime_model_3_count_diff, aes(x=long, y=lat, group=group, fill=crime_difference), color = "black", size=0.2) 
model_3_map <- model_3_map + coord_map() 
model_3_map <- model_3_map + labs(x="", y="", title=paste("Difference in Crime Count by Zipcode"), caption="Model 3", fill="Count Difference")
model_3_map <- model_3_map + cleanup + scale_fill_gradient(low = "blue", high = "orange")
print(model_3_map)
```


### Running Mean Plots

```{r}
running_mean_plot(crime_data_3$beta)
running_mean_plot(crime_data_3$delta)
running_mean_plot(crime_data_3$sigma.1.)
running_mean_plot(crime_data_3$sigma.4.)
running_mean_plot(crime_data_3$sigma.5.)
```


--------------------------------------------------------


## Model 4: Violent vs Non-violent Crime
```{r}
violent = c("ROBBERY", "BATTERY", "BURGLARY", "ASSAULT", "HOMICIDE", "ARSON", "CRIM SEXUAL ASSAULT", "SEX OFFENSE")
Violent_Crime <- Crime %>%
  filter(Primary.Type %in% violent)
NonViolent_Crime <- Crime %>%
  filter(!(Primary.Type %in% violent))
```


**Violent Data**
```{r}
#Violent model data

#load shapefile
zip_shp <- readOGR(dsn="Boundaries - ZIP Codes", layer="geo_export_e1262361-5c82-45ee-8427-ef228e06dc4a")
temp <- zip_shp
zip_df <- fortify(temp, region = "zip")

#needs to reassign CRS for shapefile
new_CRS <- CRS("+init=epsg:4326 +proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0")
zip_shp <- sp::spTransform(zip_shp, new_CRS)

#summarize crime count per year
years <- unique(Crime$Year)
Hotspot_Crime_Violent <- data.frame()

for(i in 1:length(years)){
  year <- years[i]
  Current_Year <- Violent_Crime %>% filter(Year == year)
  
  locations <- with(Current_Year, as.data.frame(cbind(Longitude, Latitude)))
  coordinates(locations) <- ~Longitude+Latitude
  proj4string(locations) <- CRS("+init=epsg:4326")
      
  #prepping the data: project points to polygons
  proj4string(zip_shp) <- new_CRS
  proj4string(locations) <- new_CRS
  by_zip <- over(locations, zip_shp)
  
  by_zip <- by_zip %>%
    group_by(zip) %>%
    dplyr::summarise(total=n()) %>%
    filter(!is.na(zip)) %>%
    mutate(id = as.character(zip))
  
  total_map <- left_join(zip_df, by_zip)
  total_map <- total_map %>% mutate(Year = year)
  
  Hotspot_Crime_Violent <- rbind(Hotspot_Crime_Violent, total_map)
}

data("df_zip_demographics")
Demographics <- df_zip_demographics %>% mutate(zip = region)
Hotspot_Crime_Violent <- inner_join(Hotspot_Crime_Violent, Demographics, by="zip") 
Model_Data_Violent <- Hotspot_Crime_Violent %>%
  select(-c(lat, long, order, piece, group, hole)) %>% distinct

Model_Data_Violent <- transform(Model_Data_Violent, id=match(zip, unique(zip)))
Model_Data_Violent$time = Model_Data_Violent$Year-2009
Model_Data_Violent$racegr <- ifelse(Model_Data_Violent$percent_white >80, 1, 
                            ifelse(Model_Data_Violent$percent_white <=80 & Model_Data_Violent$percent_white > 60,2,
                            ifelse(Model_Data_Violent$percent_white <=60 & Model_Data_Violent$percent_white > 40,3,
                            ifelse(Model_Data_Violent$percent_white <=40 & Model_Data_Violent$percent_white > 20,4, 5)))) 
Model_Data_Violent$income = scale(Model_Data_Violent$per_capita_income)[,1]
```

```{r}
write.csv(Model_Data_Violent, "Crime_models_violent_data.csv")
```

**Nonviolent Data**
```{r}
#Violent model data

#load shapefile
zip_shp <- readOGR(dsn="Boundaries - ZIP Codes", layer="geo_export_e1262361-5c82-45ee-8427-ef228e06dc4a")
temp <- zip_shp
zip_df <- fortify(temp, region = "zip")

#needs to reassign CRS for shapefile
new_CRS <- CRS("+init=epsg:4326 +proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0")
zip_shp <- sp::spTransform(zip_shp, new_CRS)

#summarize crime count per year
years <- unique(NonViolent_Crime$Year)
Hotspot_Crime_Nviolent <- data.frame()

for(i in 1:length(years)){
  year <- years[i]
  Current_Year <- NonViolent_Crime %>% filter(Year == year)
  
  locations <- with(Current_Year, as.data.frame(cbind(Longitude, Latitude)))
  coordinates(locations) <- ~Longitude+Latitude
  proj4string(locations) <- CRS("+init=epsg:4326")
      
  #prepping the data: project points to polygons
  proj4string(zip_shp) <- new_CRS
  proj4string(locations) <- new_CRS
  by_zip <- over(locations, zip_shp)
  
  by_zip <- by_zip %>%
    group_by(zip) %>%
    dplyr::summarise(total=n()) %>%
    filter(!is.na(zip)) %>%
    mutate(id = as.character(zip))
  
  total_map <- left_join(zip_df, by_zip)
  total_map <- total_map %>% mutate(Year = year)
  
  Hotspot_Crime_Nviolent <- rbind(Hotspot_Crime_Nviolent, total_map)
}

data("df_zip_demographics")
Demographics <- df_zip_demographics %>% mutate(zip = region)
Hotspot_Crime_Nviolent <- inner_join(Hotspot_Crime_Nviolent, Demographics, by="zip") 
Model_Data_Nviolent <- Hotspot_Crime_Nviolent %>%
  select(-c(lat, long, order, piece, group, hole)) %>% distinct

Model_Data_Nviolent <- transform(Model_Data_Nviolent, id=match(zip, unique(zip)))
Model_Data_Nviolent$time = Model_Data_Nviolent$Year-2009
Model_Data_Nviolent$racegr <- ifelse(Model_Data_Nviolent$percent_white >80, 1, 
                            ifelse(Model_Data_Nviolent$percent_white <=80 & Model_Data_Nviolent$percent_white > 60,2,
                            ifelse(Model_Data_Nviolent$percent_white <=60 & Model_Data_Nviolent$percent_white > 40,3,
                            ifelse(Model_Data_Nviolent$percent_white <=40 & Model_Data_Nviolent$percent_white > 20,4, 5)))) 
Model_Data_Nviolent$income = scale(Model_Data_Nviolent$per_capita_income)[,1]
```

```{r}
write.csv(Model_Data_Nviolent, "Crime_models_nonviolent_data.csv")
```

**Model 1: Time trend**
```{r, cache=TRUE}
#Data
data = list(y=Model_Data_Violent$total, n=Model_Data_Violent$total_population, time=Model_Data_Violent$time, zipid=Model_Data_Violent$id, ns=length(Model_Data_Violent$total), nzip=length(unique(Model_Data_Violent$id)))

data.NV = list(y=Model_Data_Nviolent$total, n=Model_Data_Nviolent$total_population, time=Model_Data_Nviolent$time, zipid=Model_Data_Nviolent$id, ns=length(Model_Data_Nviolent$total), nzip=length(unique(Model_Data_Nviolent$id)))
```

```{r, cache=TRUE}
#Specify the model
crime_model_1 <- "model{
    #Data
    for(i in 1:ns) {
      y[i] ~ dbin(p[i], n[i])
      logit(p[i]) = beta[zipid[i]] + delta[zipid[i]]*time[i]
    }
    
    #Priors
    for(j in 1:nzip){
      delta[j] ~ dnorm(0, tau_1)
      beta[j] ~ dnorm(0, tau_0)
    }

    #Hyperpriors
    tau_0 ~ dgamma(0.5, 0.0005)
    tau_1 ~ dgamma(0.5, 0.0005)
    
}"

#set up an algorithm to simulate the posterior
#set the random number seed
init.rng1<-list(".RNG.seed" = 1998, ".RNG.name" = "base::Mersenne-Twister")
crimeV_jags_1 <- jags.model(textConnection(crime_model_1), data=data,
                    inits=init.rng1)
crimeNV_jags_1 <- jags.model(textConnection(crime_model_1), data=data.NV,
                    inits=init.rng1)


#simulate a sample from the posterior 
crimeV_sim_1 <- coda.samples(crimeV_jags_1, variable.names=c("delta", "beta", "tau_0", "tau_1"), n.iter=30000)

crimeNV_sim_1 <- coda.samples(crimeNV_jags_1, variable.names=c("delta", "beta", "tau_0", "tau_1"), n.iter=30000)


#store the samples in a data frame:    
crimeV_data_1 <- data.frame( crimeV_sim_1[[1]])
crimeNV_data_1 <- data.frame( crimeNV_sim_1[[1]])
```

### Parameter Interpretation
#### Posterior Distribution
```{r}
ggplot(crimeV_data_1, aes(x=delta.1.)) + geom_histogram(aes(y=..density..), colour="white") + labs(title="Posterior Distribution of the Violent Crime Differential Growth in 2010", x="Violent Crime Differential Growth", y="Density")
```

### Confidence Intervals and Posterior Means of Crime Model 1 Parameters
```{r}
n = length(unique(Model_Data_Violent$zip))

#posterior mean and quantile of delta only

crimeV_model_1_CI <- matrix(nrow=n, ncol=2)
for (i in 1:n) {
      crimeV_model_1_CI[i, ] <- quantile(crimeV_data_1[[i+n]], c(0.025, 0.975))
}

crimeV_model_1_mean <- matrix(nrow=n, ncol=1)
for (i in 1:n) {
      crimeV_model_1_mean[i, ] <- mean(crimeV_data_1[[i+n]])
}

crimeV_model_1_table <- cbind(crimeV_model_1_CI, crimeV_model_1_mean)
rownames(crimeV_model_1_table) <- names(crimeV_data_1)[59:116]
colnames(crimeV_model_1_table) <- c("2.5%", "97.5%", "Mean")
as.table(crimeV_model_1_table)
```

```{r}
n = length(unique(Model_Data_Nviolent$zip))

#posterior mean and quantile of delta only

crimeNV_model_1_CI <- matrix(nrow=n, ncol=2)
for (i in 1:n) {
      crimeNV_model_1_CI[i, ] <- quantile(crimeNV_data_1[[i+n]], c(0.025, 0.975))
}

crimeNV_model_1_mean <- matrix(nrow=n, ncol=1)
for (i in 1:n) {
      crimeNV_model_1_mean[i, ] <- mean(crimeNV_data_1[[i+n]])
}

crimeNV_model_1_table <- cbind(crimeNV_model_1_CI, crimeNV_model_1_mean)
rownames(crimeNV_model_1_table) <- names(crimeNV_data_1)[59:116]
colnames(crimeNV_model_1_table) <- c("2.5%", "97.5%", "Mean")
as.table(crimeNV_model_1_table)
```

## Violent Crime Model 1 Visualizations

### Map of Crime Differential Growth by Zipcode (Using Model 1)
```{r, cache=TRUE}
zip <- readOGR(dsn="Boundaries - ZIP Codes", layer="geo_export_e1262361-5c82-45ee-8427-ef228e06dc4a")
zip_df <- fortify(zip, region = "zip")
crimeV_model_1_delta <- left_join(zip_df, data.frame(id=as.character(unique(Model_Data_Violent$zip)), delta=crimeV_model_1_mean), by='id')
head(crimeV_model_1_delta)

model_1_map <- ggplot() 
model_1_map <- model_1_map +  geom_polygon(data = crimeV_model_1_delta, aes(x=long, y=lat, group=group, fill=delta), color = "black", size=0.2) 
model_1_map <- model_1_map + coord_map() 
model_1_map <- model_1_map + labs(x="", y="", title=paste("Violent Crime Differential Growth by Zipcode"), fill="Trend over Time", caption="Model 1")
model_1_map <- model_1_map + cleanup + scale_fill_gradient(low = "blue", high = "orange")
print(model_1_map)
```

```{r, cache=TRUE}
zip <- readOGR(dsn="Boundaries - ZIP Codes", layer="geo_export_e1262361-5c82-45ee-8427-ef228e06dc4a")
zip_df <- fortify(zip, region = "zip")
crimeNV_model_1_delta <- left_join(zip_df, data.frame(id=as.character(unique(Model_Data_Nviolent$zip)), delta=crimeNV_model_1_mean), by='id')
head(crimeNV_model_1_delta)

model_1_map <- ggplot() 
model_1_map <- model_1_map +  geom_polygon(data = crimeNV_model_1_delta, aes(x=long, y=lat, group=group, fill=delta), color = "black", size=0.2) 
model_1_map <- model_1_map + coord_map() 
model_1_map <- model_1_map + labs(x="", y="", title=paste("Non-Violent Crime Differential Growth by Zipcode"), fill="Trend over Time", caption="Model 1")
model_1_map <- model_1_map + cleanup + scale_fill_gradient(low = "blue", high = "orange")
print(model_1_map)
```

**Model 2: Demographics trend**
```{r}
Model2_Data_NViolent <- Model_Data_Nviolent %>% filter(Year==2010)

Model2_Data_Violent <- Model_Data_Violent %>% filter(Year==2010)

data.v = list(y=Model2_Data_Violent$total, n=Model2_Data_Violent$total_population, racegr=Model2_Data_Violent$racegr, income=Model2_Data_Violent$income, ns=nrow(Model2_Data_Violent))

data.NV = list(y=Model2_Data_NViolent$total, n=Model2_Data_NViolent$total_population, racegr=Model2_Data_NViolent$racegr, income=Model2_Data_NViolent$income, ns=nrow(Model2_Data_NViolent))
```

```{r, cache=TRUE, message=FALSE, warning=FALSE}
#Specify the model
crime_model_2_v <- "model{
    #Data
    for(i in 1:ns) {
      y[i] ~ dbin(p[i], n[i])
      logit(p[i]) = beta[racegr[i]] + sigma[racegr[i]]*income[i]
    }
    
    #Priors
    for(j in 1:5){
      sigma[j] ~ dnorm(0, tau_1)
      beta[j] ~ dnorm(0, tau_0)
    }

    #Hyperpriors
    tau_0 ~ dgamma(0.5, 0.0005)
    tau_1 ~ dgamma(0.5, 0.0005)
    
}"

#set up an algorithm to simulate the posterior by 
#combining the model (nba_model) and data (y)
#set the random number seed
crimeV_jags_2 <- jags.model(textConnection(crime_model_2_v), data=data.v,
                    inits=list(.RNG.name="base::Wichmann-Hill", .RNG.seed=1989))
crimeNV_jags_2 <- jags.model(textConnection(crime_model_2_v), data=data.NV,
                    inits=list(.RNG.name="base::Wichmann-Hill", .RNG.seed=1989))


#simulate a sample from the posterior 
#note that we specify both mu and tau variables
crimeV_sim_2 <- coda.samples(crimeV_jags_2, variable.names=c("sigma", "tau_0", "beta","tau_1"), n.iter=30000, n.thin=5)
crimeNV_sim_2 <- coda.samples(crimeNV_jags_2, variable.names=c("sigma", "tau_0", "beta","tau_1"), n.iter=30000, n.thin=5)


#store the samples in a data frame:    
crimeV_data_2 <- data.frame(crimeV_sim_2[[1]])
crimeNV_data_2 <- data.frame(crimeNV_sim_2[[1]])
```


## Crime Model 2 Visualizations

```{r}
posterior_means <- crimeV_data_2 %>% colMeans()
posterior_means
crimeV_model_2_sigma <- Model_Data_Violent
crimeV_model_2_sigma$beta <- recode(crimeV_model_2_sigma$racegr, `1`=posterior_means[1],
                                   `2`=posterior_means[2],
                                   `3`=posterior_means[3],
                                   `4`=posterior_means[4],
                                   `5`=posterior_means[5])
crimeV_model_2_sigma$sigma <- recode(crimeV_model_2_sigma$racegr, `1`=posterior_means[6],
                                   `2`=posterior_means[7],
                                   `3`=posterior_means[8],
                                   `4`=posterior_means[9],
                                   `5`=posterior_means[10])
crimeV_model_2_sigma <- crimeV_model_2_sigma %>%
  mutate(id = as.character(zip)) %>%
  right_join(zip_df, by="id")

posterior_means <- crimeNV_data_2 %>% colMeans()
posterior_means
crimeNV_model_2_sigma <- Model_Data_Nviolent
crimeNV_model_2_sigma$beta <- recode(crimeNV_model_2_sigma$racegr, `1`=posterior_means[1],
                                   `2`=posterior_means[2],
                                   `3`=posterior_means[3],
                                   `4`=posterior_means[4],
                                   `5`=posterior_means[5])
crimeNV_model_2_sigma$sigma <- recode(crimeNV_model_2_sigma$racegr, `1`=posterior_means[6],
                                   `2`=posterior_means[7],
                                   `3`=posterior_means[8],
                                   `4`=posterior_means[9],
                                   `5`=posterior_means[10])
crimeNV_model_2_sigma <- crimeNV_model_2_sigma %>%
  mutate(id = as.character(zip)) %>%
  right_join(zip_df, by="id")
```


### Income Differential Growth by Zipcode (Using Model 2)
```{r, cache=TRUE}
model_2_map <- ggplot() 
model_2_map <- model_2_map +  geom_polygon(data = crimeV_model_2_sigma, aes(x=long, y=lat, group=group, fill=sigma), color = "black", size=0.2) 
model_2_map <- model_2_map + coord_map() 
model_2_map <- model_2_map + labs(x="", y="", title=paste("Violent Crime Differential Growth"), fill="Trend over Time", caption="Model 3")
model_2_map <- model_2_map + cleanup + scale_fill_gradient(low = "blue", high = "orange")
print(model_2_map)
```

```{r, cache=TRUE}
model_2_map <- ggplot() 
model_2_map <- model_2_map +  geom_polygon(data = crimeNV_model_2_sigma, aes(x=long, y=lat, group=group, fill=sigma), color = "black", size=0.2) 
model_2_map <- model_2_map + coord_map() 
model_2_map <- model_2_map + labs(x="", y="", title=paste("Non-Violent Crime Differential Growth"), fill="Trend over Time", caption="Model 2")
model_2_map <- model_2_map + cleanup + scale_fill_gradient(low = "blue", high = "orange")
print(model_2_map)

posterior_means
#Five groups, 20% increase in percent white. Darkest blue is the areas with 20% or lower of population white.
#See Posterior means
```
